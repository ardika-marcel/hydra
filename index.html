<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üíß AquaTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<style>
:root {
  --blue-deep: #1a6b9a;
  --blue-mid: #2196f3;
  --blue-pale: #e3f2fd;
  --aqua: #00bcd4;
  --bg: #f0f8ff;
  --text: #1a2744;
  --text-light: #5a7a9a;
  --accent: #ff7043;
  --shadow: 0 4px 20px rgba(33,150,243,0.15);
  --radius: 20px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Nunito',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; }

/* NAV */
nav { background:linear-gradient(135deg,#1a6b9a,#2196f3); display:flex; align-items:center; justify-content:space-between; box-shadow:0 4px 15px rgba(33,150,243,0.3); position:sticky; top:0; z-index:100; }
.nav-logo { font-family:'Fredoka One',cursive; font-size:1.6rem; color:white; padding:14px 24px; }
.nav-tabs { display:flex; }
.nav-tab { padding:18px 28px; color:rgba(255,255,255,0.7); cursor:pointer; font-weight:800; font-size:0.95rem; border:none; background:none; transition:all 0.2s; position:relative; }
.nav-tab::after { content:''; position:absolute; bottom:0; left:50%; right:50%; height:3px; background:white; border-radius:3px 3px 0 0; transition:all 0.25s; }
.nav-tab.active { color:white; }
.nav-tab.active::after { left:10%; right:10%; }
.nav-tab:hover { color:white; }

/* PAGES */
.page { display:none; padding:32px 20px; max-width:960px; margin:0 auto; width:100%; }
.page.active { display:block; }
.page-title { font-family:'Fredoka One',cursive; font-size:2rem; color:var(--blue-deep); text-align:center; margin-bottom:6px; }
.page-sub { color:var(--text-light); font-size:1rem; text-align:center; font-weight:600; margin-bottom:24px; }

/* PAGE 1 BOTTLE */
.bottle-layout { display:flex; align-items:center; justify-content:center; gap:40px; flex-wrap:wrap; }
.bottle-wrap { display:flex; flex-direction:column; align-items:center; gap:10px; }
.bottle-hint { font-size:0.8rem; color:var(--text-light); font-weight:700; }
.bottle-svg-wrap { cursor:pointer; filter:drop-shadow(0 8px 20px rgba(33,150,243,0.25)); transition:transform 0.15s; }
.bottle-svg-wrap:hover { transform:translateY(-4px) scale(1.02); }
.ml-label { font-family:'Nunito',sans-serif; font-size:11px; font-weight:700; fill:#1a6b9a; }

.controls-panel { background:white; border-radius:var(--radius); padding:28px; box-shadow:var(--shadow); width:100%; max-width:380px; }
.controls-panel h3 { font-family:'Fredoka One',cursive; color:var(--blue-deep); font-size:1.3rem; margin-bottom:4px; }
.controls-sub { font-size:0.8rem; color:var(--text-light); font-weight:600; margin-bottom:18px; }

.current-display { text-align:center; margin-bottom:20px; background:var(--blue-pale); border-radius:14px; padding:16px; }
.current-ml-big { font-family:'Fredoka One',cursive; font-size:2.8rem; color:var(--blue-mid); line-height:1; }
.current-ml-big span { font-size:1.1rem; font-family:'Nunito',sans-serif; font-weight:700; color:var(--text-light); }
.goal-pct { font-size:0.85rem; color:var(--text-light); font-weight:700; margin-top:4px; }
.goal-bar-wrap { height:8px; background:#ddd; border-radius:4px; margin-top:8px; overflow:hidden; }
.goal-bar-fill { height:100%; background:linear-gradient(90deg,#2196f3,#00bcd4); border-radius:4px; transition:width 0.4s; }

.quick-btns { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:16px; }
.qbtn { background:var(--blue-pale); border:2px solid transparent; border-radius:12px; padding:10px 4px; cursor:pointer; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.82rem; color:var(--blue-deep); transition:all 0.2s; text-align:center; }
.qbtn:hover { background:var(--blue-mid); color:white; transform:translateY(-2px); box-shadow:0 4px 12px rgba(33,150,243,0.3); }

.input-row { display:flex; gap:8px; margin-bottom:10px; }
.input-row input { flex:1; padding:11px 14px; border:2px solid #e0e0e0; border-radius:12px; font-family:'Nunito',sans-serif; font-weight:700; font-size:1rem; color:var(--text); outline:none; transition:border-color 0.2s; min-width:0; }
.input-row input:focus { border-color:var(--blue-mid); }
.btn-add { padding:11px 16px; background:linear-gradient(135deg,var(--blue-mid),var(--aqua)); color:white; border:none; border-radius:12px; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.95rem; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.btn-add:hover { transform:translateY(-2px); box-shadow:0 4px 14px rgba(33,150,243,0.4); }
.btn-sub { padding:11px 16px; background:#fff3e0; color:#e65100; border:2px solid #ffccbc; border-radius:12px; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.95rem; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.btn-sub:hover { background:var(--accent); color:white; transform:translateY(-2px); }

.congrats { display:none; background:linear-gradient(135deg,#43a047,#66bb6a); color:white; border-radius:16px; padding:14px 20px; text-align:center; font-family:'Fredoka One',cursive; font-size:1.2rem; margin-top:12px; box-shadow:0 4px 15px rgba(76,175,80,0.3); }

/* PAGE 2 CALENDAR */
.cal-header { display:flex; align-items:center; justify-content:space-between; background:white; border-radius:var(--radius); padding:16px 24px; box-shadow:var(--shadow); margin-bottom:20px; }
.cal-nav { background:var(--blue-pale); border:none; border-radius:10px; width:40px; height:40px; cursor:pointer; font-size:1.4rem; color:var(--blue-deep); font-weight:900; transition:all 0.2s; display:flex; align-items:center; justify-content:center; }
.cal-nav:hover { background:var(--blue-mid); color:white; }
.cal-month-label { font-family:'Fredoka One',cursive; font-size:1.5rem; color:var(--blue-deep); }
.cal-grid { background:white; border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
.cal-dow { display:grid; grid-template-columns:repeat(7,1fr); background:linear-gradient(135deg,#1a6b9a,#2196f3); }
.cal-dow div { padding:12px 4px; text-align:center; color:rgba(255,255,255,0.9); font-weight:800; font-size:0.82rem; }
.cal-cells { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#ececec; }
.cal-cell { background:white; padding:8px 6px; min-height:75px; cursor:pointer; transition:background 0.15s; display:flex; flex-direction:column; gap:4px; }
.cal-cell:hover { background:var(--blue-pale); }
.cal-cell.empty { background:#fafafa; cursor:default; }
.cal-cell.empty:hover { background:#fafafa; }
.cal-cell.today { background:#e8f4fd; }
.cal-cell.has-data { background:linear-gradient(135deg,rgba(33,150,243,0.06),rgba(0,188,212,0.06)); }
.cal-date-num { font-weight:800; font-size:0.9rem; width:26px; height:26px; display:flex; align-items:center; justify-content:center; border-radius:50%; }
.cal-cell.today .cal-date-num { background:var(--blue-mid); color:white; }
.cal-bar-wrap { width:100%; height:5px; background:#e0e0e0; border-radius:3px; overflow:hidden; }
.cal-bar-fill { height:100%; background:linear-gradient(90deg,#2196f3,#00bcd4); border-radius:3px; }
.cal-ml-txt { font-size:0.68rem; font-weight:800; color:var(--blue-deep); }

/* MODAL */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(26,39,68,0.5); z-index:200; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px); }
.modal-overlay.open { display:flex; }
.modal { background:white; border-radius:24px; padding:28px; max-width:400px; width:100%; box-shadow:0 20px 60px rgba(33,150,243,0.25); animation:slideUp 0.25s ease; }
@keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
.modal-date-title { font-family:'Fredoka One',cursive; font-size:1.3rem; color:var(--blue-deep); margin-bottom:4px; }
.modal-total-big { font-family:'Fredoka One',cursive; font-size:2.2rem; color:var(--blue-mid); }
.modal-total-big span { font-size:1rem; font-family:'Nunito',sans-serif; font-weight:700; color:var(--text-light); }
.modal-prog-wrap { height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden; margin:10px 0 14px; }
.modal-prog-fill { height:100%; background:linear-gradient(90deg,#2196f3,#00bcd4); border-radius:4px; transition:width 0.3s; }
.modal-entries { max-height:180px; overflow-y:auto; margin-bottom:14px; display:flex; flex-direction:column; gap:6px; }
.modal-entry { display:flex; align-items:center; justify-content:space-between; background:var(--blue-pale); border-radius:10px; padding:8px 12px; font-weight:700; }
.modal-entry-time { color:var(--text-light); font-size:0.82rem; }
.modal-entry-ml { color:var(--blue-deep); }
.modal-del-btn { background:none; border:none; cursor:pointer; color:#ef9a9a; font-size:1rem; padding:2px 6px; border-radius:6px; font-weight:900; transition:all 0.15s; }
.modal-del-btn:hover { background:#ffebee; color:#e53935; }
.modal-add-row { display:flex; gap:8px; margin-bottom:10px; }
.modal-add-row input { flex:1; padding:10px 14px; border:2px solid #e0e0e0; border-radius:10px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.95rem; outline:none; min-width:0; }
.modal-add-row input:focus { border-color:var(--blue-mid); }
.modal-close-btn { width:100%; padding:10px; background:#f5f5f5; border:none; border-radius:10px; font-family:'Nunito',sans-serif; font-weight:800; cursor:pointer; color:var(--text-light); transition:background 0.2s; }
.modal-close-btn:hover { background:#e0e0e0; }

/* PAGE 3 STATS */
.stats-top { display:flex; align-items:center; gap:12px; margin-bottom:20px; }
.year-sel { background:white; border:2px solid #e0e0e0; border-radius:12px; padding:10px 16px; font-family:'Nunito',sans-serif; font-weight:700; font-size:1rem; color:var(--text); cursor:pointer; outline:none; transition:border-color 0.2s; }
.year-sel:focus { border-color:var(--blue-mid); }
.summary-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:14px; margin-bottom:22px; }
.s-card { background:white; border-radius:16px; padding:18px 14px; box-shadow:var(--shadow); text-align:center; }
.s-card-val { font-family:'Fredoka One',cursive; font-size:1.9rem; color:var(--blue-mid); line-height:1; }
.s-card-label { font-size:0.75rem; font-weight:800; color:var(--text-light); margin-top:4px; text-transform:uppercase; letter-spacing:0.5px; }
.chart-card { background:white; border-radius:var(--radius); padding:24px; box-shadow:var(--shadow); margin-bottom:20px; }
.chart-title { font-family:'Fredoka One',cursive; font-size:1.2rem; color:var(--blue-deep); margin-bottom:16px; }
.chart-wrap { position:relative; height:260px; width:100%; }

/* TOAST */
#toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); color:white; padding:12px 24px; border-radius:14px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.95rem; z-index:9999; box-shadow:0 4px 20px rgba(0,0,0,0.2); opacity:0; transition:opacity 0.3s; pointer-events:none; white-space:nowrap; }

@media(max-width:620px) {
  .nav-tab { padding:14px 12px; font-size:0.78rem; }
  .nav-logo { font-size:1.2rem; padding:12px 14px; }
  .quick-btns { grid-template-columns:repeat(3,1fr); }
  .bottle-layout { gap:20px; }
  .input-row { flex-wrap:wrap; }
}
</style>
</head>
<body>

<nav>
  <div class="nav-logo">üíß AquaTrack</div>
  <div class="nav-tabs">
    <button class="nav-tab active" id="tab-bottle"   onclick="showPage('bottle')">üç∂ Bottle</button>
    <button class="nav-tab"        id="tab-calendar" onclick="showPage('calendar')">üìÖ Calendar</button>
    <button class="nav-tab"        id="tab-stats"    onclick="showPage('stats')">üìà Stats</button>
  </div>
</nav>

<!-- PAGE 1 -->
<div id="page-bottle" class="page active">
  <h1 class="page-title">Today's Water Intake üíß</h1>
  <p class="page-sub">Stay hydrated! Your daily goal is 2,000 ml.</p>
  <div class="bottle-layout">

    <div class="bottle-wrap">
      <div class="bottle-svg-wrap" onclick="addWater(100)" title="Click to +100 ml">
        <svg width="165" height="430" viewBox="0 0 165 430" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="wGrad" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%"   stop-color="#42a5f5" stop-opacity="0.88"/>
              <stop offset="100%" stop-color="#00bcd4" stop-opacity="0.88"/>
            </linearGradient>
            <linearGradient id="bGrad" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%"   stop-color="#e3f2fd"/>
              <stop offset="100%" stop-color="#bbdefb"/>
            </linearGradient>
            <clipPath id="bClip">
              <path d="M46,90 L34,112 Q26,124 26,136 L26,378 Q26,398 82,398 Q138,398 138,378 L138,136 Q138,124 130,112 L118,90 Z"/>
            </clipPath>
          </defs>
          <!-- cap -->
          <rect x="63" y="28" width="38" height="28" rx="6" fill="#2196f3"/>
          <rect x="70" y="22" width="24" height="10" rx="4" fill="#1565c0"/>
          <!-- neck -->
          <path d="M60,56 L46,90 L118,90 L104,56 Z" fill="url(#bGrad)" stroke="#90caf9" stroke-width="1.5"/>
          <!-- body -->
          <path d="M46,90 L34,112 Q26,124 26,136 L26,378 Q26,398 82,398 Q138,398 138,378 L138,136 Q138,124 130,112 L118,90 Z"
                fill="url(#bGrad)" stroke="#64b5f6" stroke-width="2.5"/>
          <!-- water -->
          <rect id="waterRect" x="26" y="398" width="112" height="0" clip-path="url(#bClip)" fill="url(#wGrad)"/>
          <!-- shine -->
          <path d="M46,90 L34,112 Q26,124 26,136 L26,230 Q44,218 54,195 L54,90 Z" fill="rgba(255,255,255,0.13)"/>
          <!-- markers -->
          <g id="mlMarkers"></g>
        </svg>
      </div>
      <div class="bottle-hint">üëÜ Click bottle to +100 ml</div>
    </div>

    <div class="controls-panel">
      <h3>üíß Add Water</h3>
      <div class="controls-sub">Tap a quick amount or enter a custom value</div>

      <div class="current-display">
        <div class="current-ml-big" id="currentMl">0 <span>ml</span></div>
        <div class="goal-pct" id="goalPct">0% of 2,000 ml goal</div>
        <div class="goal-bar-wrap"><div class="goal-bar-fill" id="goalBar" style="width:0%"></div></div>
      </div>

      <div class="quick-btns">
        <button class="qbtn" onclick="addWater(100)">+100 ml</button>
        <button class="qbtn" onclick="addWater(150)">+150 ml</button>
        <button class="qbtn" onclick="addWater(200)">+200 ml</button>
        <button class="qbtn" onclick="addWater(250)">+250 ml</button>
        <button class="qbtn" onclick="addWater(300)">+300 ml</button>
        <button class="qbtn" onclick="addWater(350)">+350 ml</button>
        <button class="qbtn" onclick="addWater(500)">+500 ml</button>
        <button class="qbtn" onclick="addWater(750)">+750 ml</button>
      </div>

      <div class="input-row">
        <input type="number" id="customMl" placeholder="Custom ml..." min="1" max="3000"/>
        <button class="btn-add" onclick="doAdd()">+ Add</button>
        <button class="btn-sub" onclick="doSub()">‚àí Minus</button>
      </div>

      <div class="congrats" id="congrats">üéâ Goal reached! Amazing job! üåü</div>
    </div>

  </div>
</div>

<!-- PAGE 2 -->
<div id="page-calendar" class="page">
  <h1 class="page-title">üìÖ My Calendar</h1>
  <p class="page-sub">Click any day to see or edit your water entries</p>

  <div class="cal-header">
    <button class="cal-nav" onclick="changeMonth(-1)">&#8249;</button>
    <div class="cal-month-label" id="calLabel">February 2026</div>
    <button class="cal-nav" onclick="changeMonth(1)">&#8250;</button>
  </div>
  <div class="cal-grid">
    <div class="cal-dow">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div class="cal-cells" id="calCells"></div>
  </div>
</div>

<!-- PAGE 3 -->
<div id="page-stats" class="page">
  <h1 class="page-title">üìà My Stats</h1>
  <p class="page-sub">Your hydration journey at a glance</p>

  <div class="stats-top">
    <select class="year-sel" id="yearSel" onchange="renderStats()">
      <option>2026</option><option>2027</option><option>2028</option>
      <option>2029</option><option>2030</option><option>2031</option>
      <option>2032</option><option>2033</option><option>2034</option><option>2035</option>
    </select>
    <select class="year-sel" id="monthSel" onchange="renderStats()">
      <option value="0">January</option><option value="1">February</option>
      <option value="2">March</option><option value="3">April</option>
      <option value="4">May</option><option value="5">June</option>
      <option value="6">July</option><option value="7">August</option>
      <option value="8">September</option><option value="9">October</option>
      <option value="10">November</option><option value="11">December</option>
    </select>
  </div>

  <div class="summary-cards" id="summaryCards"></div>

  <div class="chart-card">
    <div class="chart-title">Monthly Average (ml/day)</div>
    <div class="chart-wrap"><canvas id="chartMonthly"></canvas></div>
  </div>
  <div class="chart-card">
    <div class="chart-title" id="chartDailyTitle">Daily Total ‚Äì This Month</div>
    <div class="chart-wrap"><canvas id="chartDaily"></canvas></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="overlayClick(event)">
  <div class="modal">
    <div class="modal-date-title" id="modalTitle"></div>
    <div class="modal-total-big" id="modalTotal">0 <span>ml</span></div>
    <div class="modal-prog-wrap"><div class="modal-prog-fill" id="modalProg" style="width:0%"></div></div>
    <div class="modal-entries" id="modalEntries"></div>
    <div class="modal-add-row">
      <input type="number" id="modalInput" placeholder="Add ml..." min="1" max="3000"/>
      <button class="btn-add" onclick="modalAdd()">+ Add</button>
    </div>
    <button class="modal-close-btn" onclick="closeModal()">‚úï Close</button>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// =====================================================================
// SUPABASE CONFIG
// =====================================================================
var SUPABASE_URL = 'https://bhdedvmdfdnmlzrooyhu.supabase.co';
var SUPABASE_KEY = 'sb_publishable_PWOKuzhyUU1ePDsj8p2VLQ_1W7IFuKk';
var _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// =====================================================================
// UTILS
// =====================================================================
function pad(n) { return String(n).padStart(2, '0'); }

function todayKey() {
  var n = new Date();
  return n.getFullYear() + '-' + pad(n.getMonth() + 1) + '-' + pad(n.getDate());
}

function makeKey(y, m, d) {
  // m is 0-indexed
  return y + '-' + pad(m + 1) + '-' + pad(d);
}

// =====================================================================
// STORAGE  ‚Äî Supabase (water_entries table) with localStorage fallback
// format in memory: { "2026-02-22": [{id, ml, time}, ...], ... }
// =====================================================================
var _cache = null; // in-memory cache populated on first load

async function loadAll() {
  if (_cache) return _cache;
  // Try Supabase first
  try {
    var res = await _supabase.from('water_entries').select('*').order('logged_at', { ascending: true });
    if (res.error) throw res.error;
    var data = {};
    (res.data || []).forEach(function(row) {
      var dateKey = row.date_key; // e.g. "2026-02-22"
      if (!data[dateKey]) data[dateKey] = [];
      data[dateKey].push({ id: row.id, ml: row.ml, time: row.time_of_day });
    });
    _cache = data;
    return _cache;
  } catch(e) {
    console.warn('Supabase unavailable, falling back to localStorage', e);
    try { _cache = JSON.parse(localStorage.getItem('aqt') || '{}'); }
    catch(e2) { _cache = {}; }
    return _cache;
  }
}

function saveLocalFallback() {
  localStorage.setItem('aqt', JSON.stringify(_cache || {}));
}

function getEntries(key) {
  var d = _cache || {};
  return Array.isArray(d[key]) ? d[key] : [];
}

function getTotal(key) {
  return getEntries(key).reduce(function (s, e) { return s + e.ml; }, 0);
}

async function pushEntry(key, ml) {
  if (!_cache) _cache = {};
  var now = new Date();
  var timeStr = pad(now.getHours()) + ':' + pad(now.getMinutes());
  var entry = { ml: ml, time: timeStr };

  try {
    var res = await _supabase.from('water_entries').insert({
      date_key: key,
      ml: ml,
      time_of_day: timeStr,
      logged_at: now.toISOString()
    }).select().single();
    if (res.error) throw res.error;
    entry.id = res.data.id;
  } catch(e) {
    console.warn('Supabase write failed, using localStorage', e);
  }

  if (!Array.isArray(_cache[key])) _cache[key] = [];
  _cache[key].push(entry);
  saveLocalFallback();
}

async function spliceEntry(key, idx) {
  if (!_cache || !Array.isArray(_cache[key])) return;
  var entry = _cache[key][idx];

  if (entry && entry.id) {
    try {
      await _supabase.from('water_entries').delete().eq('id', entry.id);
    } catch(e) {
      console.warn('Supabase delete failed', e);
    }
  }

  _cache[key].splice(idx, 1);
  if (_cache[key].length === 0) delete _cache[key];
  saveLocalFallback();
}

// =====================================================================
// TOAST
// =====================================================================
var _toastTimer;
function toast(msg, bg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = bg || '#2196f3';
  t.style.opacity = '1';
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(function () { t.style.opacity = '0'; }, 2400);
}

// =====================================================================
// PAGE 1 ‚Äì BOTTLE
// =====================================================================
var GOAL = 2000;
var MAX_ML = 3000;

function drawMarkers() {
  var g = document.getElementById('mlMarkers');
  g.innerHTML = '';
  var bTop = 94, bBot = 396, tH = bBot - bTop;
  for (var ml = 100; ml <= 3000; ml += 100) {
    var y = bBot - (ml / MAX_ML) * tH;
    var big = (ml % 500 === 0);
    var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', big ? '29' : '36');
    line.setAttribute('x2', big ? '135' : '46');
    line.setAttribute('y1', y);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', ml % 1000 === 0 ? '#1565c0' : big ? '#2196f3' : '#90caf9');
    line.setAttribute('stroke-width', big ? '1.5' : '1');
    g.appendChild(line);
    if (big || ml === 100) {
      var txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      txt.setAttribute('x', '140');
      txt.setAttribute('y', y + 4);
      txt.setAttribute('class', 'ml-label');
      txt.setAttribute('text-anchor', 'start');
      txt.textContent = ml >= 1000 ? (ml / 1000) + 'L' : ml + 'ml';
      g.appendChild(txt);
    }
  }
}

async function refreshBottle() {
  await loadAll();
  var raw = getTotal(todayKey());
  var capped = Math.min(raw, MAX_ML);
  var bTop = 94, bBot = 396, tH = bBot - bTop;
  var fillH = (capped / MAX_ML) * tH;
  var rect = document.getElementById('waterRect');
  rect.setAttribute('y', bBot - fillH);
  rect.setAttribute('height', fillH);
  document.getElementById('currentMl').innerHTML = raw + ' <span>ml</span>';
  var pct = Math.min(100, Math.round((raw / GOAL) * 100));
  document.getElementById('goalPct').textContent = pct + '% of 2,000 ml goal';
  document.getElementById('goalBar').style.width = pct + '%';
  document.getElementById('congrats').style.display = raw >= GOAL ? 'block' : 'none';
}

async function addWater(ml) {
  await pushEntry(todayKey(), ml);
  await refreshBottle();
  var w = document.querySelector('.bottle-svg-wrap');
  w.style.transform = 'scale(1.06) translateY(-5px)';
  setTimeout(function () { w.style.transform = ''; }, 180);
  toast('üíß +' + ml + ' ml added!');
}

async function doAdd() {
  var v = parseInt(document.getElementById('customMl').value, 10);
  if (!v || v < 1 || v > 3000) { alert('Please enter a number between 1 and 3000'); return; }
  await addWater(v);
  document.getElementById('customMl').value = '';
}

async function doSub() {
  var v = parseInt(document.getElementById('customMl').value, 10);
  if (!v || v < 1) { alert('Please enter a number to subtract'); return; }
  var key = todayKey();
  if (!_cache) await loadAll();
  var entries = Array.isArray(_cache[key]) ? _cache[key] : [];
  var toRemove = v;
  for (var i = entries.length - 1; i >= 0 && toRemove > 0; i--) {
    if (entries[i].ml <= toRemove) {
      toRemove -= entries[i].ml;
      await spliceEntry(key, i);
      entries = Array.isArray(_cache[key]) ? _cache[key] : [];
    } else {
      // Partial reduction ‚Äî update in Supabase if we have an id
      entries[i].ml -= toRemove;
      toRemove = 0;
      if (entries[i].id) {
        try { await _supabase.from('water_entries').update({ ml: entries[i].ml }).eq('id', entries[i].id); } catch(e) {}
      }
      saveLocalFallback();
    }
  }
  document.getElementById('customMl').value = '';
  await refreshBottle();
  toast('‚ûñ ' + v + ' ml removed!', '#ff7043');
}

// =====================================================================
// PAGE 2 ‚Äì CALENDAR
// =====================================================================
var MONTHS = ['January','February','March','April','May','June',
              'July','August','September','October','November','December'];
var calY = 2026, calM = 1; // start at Feb 2026

function changeMonth(dir) {
  calM += dir;
  if (calM > 11) { calM = 0; calY++; }
  if (calM < 0)  { calM = 11; calY--; }
  if (calY < 2026 || (calY === 2026 && calM < 1)) { calY = 2026; calM = 1; }
  renderCalendar();
}

async function renderCalendar() {
  document.getElementById('calLabel').textContent = MONTHS[calM] + ' ' + calY;
  var cells = document.getElementById('calCells');
  cells.innerHTML = '';

  var firstDay    = new Date(calY, calM, 1).getDay();
  var daysInMonth = new Date(calY, calM + 1, 0).getDate();
  var today       = new Date();
  await loadAll();
  var d = _cache || {};

  // Empty leading cells
  for (var i = 0; i < firstDay; i++) {
    var emp = document.createElement('div');
    emp.className = 'cal-cell empty';
    cells.appendChild(emp);
  }

  for (var day = 1; day <= daysInMonth; day++) {
    var key     = makeKey(calY, calM, day);
    var entries = Array.isArray(d[key]) ? d[key] : [];
    var total   = entries.reduce(function (s, e) { return s + e.ml; }, 0);
    var isToday = today.getFullYear() === calY && today.getMonth() === calM && today.getDate() === day;

    var cell = document.createElement('div');
    cell.className = 'cal-cell' + (isToday ? ' today' : '') + (total > 0 ? ' has-data' : '');

    var num = document.createElement('div');
    num.className = 'cal-date-num';
    num.textContent = day;
    cell.appendChild(num);

    if (total > 0) {
      var bw = document.createElement('div'); bw.className = 'cal-bar-wrap';
      var bf = document.createElement('div'); bf.className = 'cal-bar-fill';
      bf.style.width = Math.min(100, (total / GOAL) * 100) + '%';
      bw.appendChild(bf);
      cell.appendChild(bw);
      var tx = document.createElement('div');
      tx.className = 'cal-ml-txt';
      tx.textContent = total + ' ml';
      cell.appendChild(tx);
    }

    // Closure to capture key/calY/calM/day
    (function (k, y, m, dy) {
      cell.addEventListener('click', function () { openModal(k, y, m, dy); });
    }(key, calY, calM, day));

    cells.appendChild(cell);
  }
}

// =====================================================================
// MODAL
// =====================================================================
var _modalKey = null;

async function openModal(key, y, m, day) {
  _modalKey = key;
  document.getElementById('modalTitle').textContent = 'üìÖ ' + MONTHS[m] + ' ' + day + ', ' + y;
  document.getElementById('modalInput').value = '';
  document.getElementById('modalOverlay').classList.add('open');
  await renderModalEntries();
}

async function renderModalEntries() {
  await loadAll();
  var entries = getEntries(_modalKey);
  var total   = entries.reduce(function (s, e) { return s + e.ml; }, 0);
  document.getElementById('modalTotal').innerHTML = total + ' <span>ml</span>';
  document.getElementById('modalProg').style.width = Math.min(100, (total / GOAL) * 100) + '%';

  var con = document.getElementById('modalEntries');
  con.innerHTML = '';

  if (!entries.length) {
    con.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:14px;font-weight:700;">No entries yet for this day üíß</p>';
    return;
  }

  entries.forEach(function (e, i) {
    var row = document.createElement('div'); row.className = 'modal-entry';
    var ts  = document.createElement('span'); ts.className = 'modal-entry-time'; ts.textContent = 'üïê ' + (e.time || '--:--');
    var ms  = document.createElement('span'); ms.className = 'modal-entry-ml';  ms.textContent = 'üíß ' + e.ml + ' ml';
    var btn = document.createElement('button'); btn.className = 'modal-del-btn'; btn.textContent = '‚úï';
    (function (idx) {
      btn.onclick = async function () {
        await spliceEntry(_modalKey, idx);
        await renderModalEntries();
        await renderCalendar();
        if (_modalKey === todayKey()) await refreshBottle();
      };
    }(i));
    row.appendChild(ts); row.appendChild(ms); row.appendChild(btn);
    con.appendChild(row);
  });
}

async function modalAdd() {
  var v = parseInt(document.getElementById('modalInput').value, 10);
  if (!v || v < 1 || v > 3000) { alert('Please enter a number between 1 and 3000'); return; }
  await pushEntry(_modalKey, v);
  document.getElementById('modalInput').value = '';
  await renderModalEntries();
  await renderCalendar();
  if (_modalKey === todayKey()) await refreshBottle();
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  _modalKey = null;
}

function overlayClick(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

// =====================================================================
// PAGE 3 ‚Äì STATS
// =====================================================================
var _chartMonthly = null, _chartDaily = null;

function statCard(val, label) {
  return '<div class="s-card"><div class="s-card-val">' + val + '</div><div class="s-card-label">' + label + '</div></div>';
}

async function renderStats() {
  var year = parseInt(document.getElementById('yearSel').value, 10);
  var cm   = parseInt(document.getElementById('monthSel').value, 10);
  await loadAll();
  var d = _cache || {};

  // Aggregate totals per date for selected year
  var byDate = {};
  Object.keys(d).forEach(function(k) {
    if (k.slice(0, 4) === String(year) && Array.isArray(d[k])) {
      byDate[k] = d[k].reduce(function(s, e) { return s + e.ml; }, 0);
    }
  });

  // Monthly averages (all 12 months)
  var monthlyAvg = [];
  for (var m = 0; m < 12; m++) {
    var prefix = year + '-' + pad(m + 1);
    var keys   = Object.keys(byDate).filter(function(k) { return k.slice(0, 7) === prefix; });
    if (!keys.length) { monthlyAvg.push(0); continue; }
    var sum = keys.reduce(function(s, k) { return s + byDate[k]; }, 0);
    monthlyAvg.push(Math.round(sum / keys.length));
  }

  // Daily totals for selected month
  var dim = new Date(year, cm + 1, 0).getDate();
  var dlabels = [], dvals = [];
  for (var dd = 1; dd <= dim; dd++) {
    dlabels.push(dd);
    var key = year + '-' + pad(cm + 1) + '-' + pad(dd);
    dvals.push(byDate[key] || 0);
  }
  document.getElementById('chartDailyTitle').textContent = 'Daily Total ‚Äî ' + MONTHS[cm] + ' ' + year;

  // Summary cards (for selected year)
  var allTotals = Object.values(byDate);
  var tDays = allTotals.length;
  var tMl   = allTotals.reduce(function(s, v) { return s + v; }, 0);
  var avgD  = tDays > 0 ? Math.round(tMl / tDays) : 0;
  var best  = tDays > 0 ? Math.max.apply(null, allTotals) : 0;
  var met   = allTotals.filter(function(v) { return v >= GOAL; }).length;

  document.getElementById('summaryCards').innerHTML =
    statCard(tDays,                       'Days Tracked')    +
    statCard((tMl / 1000).toFixed(1) + 'L', 'Total Consumed') +
    statCard(avgD,                        'Avg ml/Day')       +
    statCard(best + ' ml',               'Best Day')          +
    statCard(met,                         'Goals Met üéØ');

  // Chart options
  var opts = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { labels: { font: { family: 'Nunito', weight: '700' }, padding: 14 } }
    },
    scales: {
      y: { beginAtZero: true, ticks: { font: { family: 'Nunito', weight: '700' } } },
      x: { ticks: { font: { family: 'Nunito', weight: '700' }, maxRotation: 0 } }
    },
    animation: { duration: 300 }
  };

  // Monthly chart
  var mc = document.getElementById('chartMonthly');
  if (_chartMonthly) { _chartMonthly.destroy(); _chartMonthly = null; }
  _chartMonthly = new Chart(mc, {
    type: 'line',
    data: {
      labels: MONTHS.map(function(n) { return n.slice(0, 3); }),
      datasets: [
        {
          label: 'Avg ml/day', data: monthlyAvg, fill: true,
          backgroundColor: 'rgba(33,150,243,0.13)', borderColor: '#2196f3', borderWidth: 3,
          pointBackgroundColor: monthlyAvg.map(function(v) { return v >= GOAL ? '#4caf50' : '#2196f3'; }),
          pointRadius: 6, pointHoverRadius: 9, tension: 0.4
        },
        {
          label: 'Goal (' + GOAL + ' ml)', data: Array(12).fill(GOAL),
          borderColor: '#ff7043', borderWidth: 2, borderDash: [8, 4],
          pointRadius: 0, fill: false, tension: 0
        }
      ]
    },
    options: opts
  });

  // Daily chart
  var dc = document.getElementById('chartDaily');
  if (_chartDaily) { _chartDaily.destroy(); _chartDaily = null; }
  _chartDaily = new Chart(dc, {
    type: 'bar',
    data: {
      labels: dlabels,
      datasets: [
        {
          label: 'Daily ml', data: dvals,
          backgroundColor: dvals.map(function(v) { return v >= GOAL ? 'rgba(76,175,80,0.7)' : 'rgba(33,150,243,0.65)'; }),
          borderColor:      dvals.map(function(v) { return v >= GOAL ? '#388e3c' : '#1a6b9a'; }),
          borderWidth: 1.5, borderRadius: 6
        },
        {
          type: 'line',
          label: 'Goal (' + GOAL + ' ml)', data: Array(dim).fill(GOAL),
          borderColor: '#ff7043', borderWidth: 2, borderDash: [8, 4],
          pointRadius: 0, fill: false, tension: 0
        }
      ]
    },
    options: opts
  });
}

// =====================================================================
// NAVIGATION
// =====================================================================
async function showPage(page) {
  document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
  document.querySelectorAll('.nav-tab').forEach(function (t) { t.classList.remove('active'); });
  document.getElementById('page-' + page).classList.add('active');
  document.getElementById('tab-' + page).classList.add('active');
  if (page === 'calendar') await renderCalendar();
  if (page === 'stats') {
    var now2 = new Date();
    var yr = now2.getFullYear();
    document.getElementById('yearSel').value  = Math.max(2026, Math.min(2035, yr));
    document.getElementById('monthSel').value = now2.getMonth();
    await renderStats();
  }
}

// =====================================================================
// INIT
// =====================================================================
(async function init() {
  drawMarkers();
  await loadAll();
  await refreshBottle();
}());

</script>
</body>
</html>



