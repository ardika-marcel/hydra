<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aqua â€” Water Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1e;
    --surface: #111827;
    --surface2: #1a2236;
    --water: #38bdf8;
    --water2: #0ea5e9;
    --water3: #7dd3fc;
    --accent: #e0f2fe;
    --muted: #475569;
    --text: #f0f9ff;
    --text2: #94a3b8;
    --border: rgba(56,189,248,0.15);
    --glow: rgba(56,189,248,0.25);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* NAV */
  nav {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    display: flex; gap: 0; justify-content: center;
    padding: 16px;
    background: rgba(10,15,30,0.85);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }
  nav button {
    background: none; border: none; cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 12px; letter-spacing: 0.15em;
    color: var(--text2); padding: 8px 24px;
    border-radius: 40px;
    transition: all 0.3s;
    text-transform: uppercase;
  }
  nav button.active, nav button:hover {
    color: var(--water); background: rgba(56,189,248,0.1);
  }

  /* PAGES */
  .page { display: none; padding-top: 70px; min-height: 100vh; }
  .page.active { display: block; }

  /* ======= PAGE 1: BOTTLE ======= */
  #page1 {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding-top: 90px;
    padding-bottom: 40px;
    min-height: 100vh;
  }
  #page1.active { display: flex; }

  .bottle-title {
    font-family: 'Playfair Display', serif;
    font-size: clamp(28px, 5vw, 48px);
    color: var(--accent);
    margin-bottom: 8px;
    letter-spacing: 0.02em;
  }
  .bottle-subtitle {
    font-size: 11px; color: var(--text2); letter-spacing: 0.2em;
    margin-bottom: 40px; text-transform: uppercase;
  }

  .bottle-wrapper {
    display: flex; gap: 40px; align-items: flex-start;
    flex-wrap: wrap; justify-content: center;
  }

  .bottle-container {
    position: relative;
    width: 160px;
  }

  /* SVG Bottle */
  .bottle-svg {
    width: 160px;
    position: relative;
    cursor: pointer;
    filter: drop-shadow(0 0 20px rgba(56,189,248,0.3));
    transition: filter 0.3s;
  }
  .bottle-svg:hover { filter: drop-shadow(0 0 30px rgba(56,189,248,0.5)); }

  .bottle-labels {
    position: absolute;
    right: -70px;
    top: 0;
    height: 100%;
    display: flex;
    flex-direction: column-reverse;
    justify-content: space-between;
    padding: 34px 0 14px;
  }
  .bottle-label {
    font-size: 10px;
    color: var(--text2);
    letter-spacing: 0.08em;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .bottle-label::before {
    content: '';
    display: block;
    width: 14px;
    height: 1px;
    background: var(--border);
  }
  .bottle-label.active-label { color: var(--water); }
  .bottle-label.active-label::before { background: var(--water); }

  .bottle-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-top: 20px;
  }

  .info-box {
    text-align: center;
    margin-top: 16px;
  }
  .ml-display {
    font-family: 'Playfair Display', serif;
    font-size: 52px;
    color: var(--water);
    line-height: 1;
    text-shadow: 0 0 30px rgba(56,189,248,0.5);
  }
  .ml-label { font-size: 11px; color: var(--text2); letter-spacing: 0.2em; margin-top: 4px; }

  .btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--water);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.15em;
    padding: 10px 28px;
    border-radius: 40px;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: uppercase;
  }
  .btn:hover { background: rgba(56,189,248,0.15); border-color: var(--water); box-shadow: 0 0 20px var(--glow); }
  .btn-primary { background: var(--water2); color: var(--bg); border-color: var(--water2); }
  .btn-primary:hover { background: var(--water); box-shadow: 0 0 30px var(--glow); }

  .slider-row {
    display: flex; align-items: center; gap: 14px;
  }
  input[type=range] {
    -webkit-appearance: none;
    width: 200px; height: 4px;
    background: linear-gradient(to right, var(--water2) var(--pct, 0%), var(--surface2) var(--pct, 0%));
    border-radius: 4px; outline: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: var(--water);
    cursor: pointer;
    box-shadow: 0 0 10px var(--glow);
  }

  .goal-reached {
    font-size: 12px; letter-spacing: 0.15em;
    color: #4ade80; text-transform: uppercase;
    animation: pulse 1.5s ease-in-out infinite;
    display: none;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* ======= PAGE 2: CALENDAR ======= */
  #page2 {
    display: none;
    flex-direction: column;
    align-items: center;
    padding-top: 90px;
    padding-bottom: 60px;
  }
  #page2.active { display: flex; }

  .cal-header {
    display: flex; align-items: center; gap: 24px;
    margin-bottom: 36px;
  }
  .cal-title {
    font-family: 'Playfair Display', serif;
    font-size: 32px; color: var(--accent);
    min-width: 220px; text-align: center;
  }
  .cal-nav { background: none; border: 1px solid var(--border); color: var(--water); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 16px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
  .cal-nav:hover { background: rgba(56,189,248,0.1); }

  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    width: min(700px, 95vw);
  }
  .cal-day-name {
    text-align: center; font-size: 10px; letter-spacing: 0.2em;
    color: var(--muted); padding-bottom: 8px; text-transform: uppercase;
  }
  .cal-day {
    aspect-ratio: 1;
    border: 1px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.25s;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 4px;
    position: relative;
    overflow: hidden;
    background: var(--surface);
  }
  .cal-day:hover { border-color: var(--water); box-shadow: 0 0 15px var(--glow); }
  .cal-day.empty { border: none; background: none; cursor: default; }
  .cal-day.today { border-color: var(--water2); }
  .cal-day.has-data { border-color: rgba(56,189,248,0.4); }
  .cal-day .day-num { font-size: 13px; color: var(--text2); z-index: 1; }
  .cal-day.today .day-num { color: var(--water); font-weight: 500; }
  .cal-day .day-ml { font-size: 9px; color: var(--water3); letter-spacing: 0.05em; z-index: 1; }
  .cal-day .water-fill {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(to top, rgba(56,189,248,0.3), rgba(14,165,233,0.05));
    transition: height 0.5s ease;
  }

  /* Modal */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 200;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    width: min(400px, 90vw);
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp { from{transform:translateY(30px);opacity:0} to{transform:translateY(0);opacity:1} }
  .modal h3 {
    font-family: 'Playfair Display', serif;
    font-size: 22px; color: var(--accent);
    margin-bottom: 6px;
  }
  .modal .modal-date { font-size: 11px; color: var(--text2); letter-spacing: 0.15em; margin-bottom: 28px; text-transform: uppercase; }
  .modal-ml {
    font-family: 'Playfair Display', serif;
    font-size: 56px; color: var(--water);
    text-align: center;
    text-shadow: 0 0 30px rgba(56,189,248,0.4);
    margin-bottom: 6px;
  }
  .modal-ml-label { text-align: center; font-size: 11px; color: var(--text2); letter-spacing: 0.2em; margin-bottom: 24px; }
  .modal-input {
    width: 100%; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 10px;
    color: var(--text); font-family: 'DM Mono', monospace;
    font-size: 16px; padding: 14px 16px;
    outline: none; transition: border-color 0.3s;
    margin-bottom: 16px;
  }
  .modal-input:focus { border-color: var(--water); box-shadow: 0 0 10px var(--glow); }
  .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }

  /* ======= PAGE 3: STATS ======= */
  #page3 {
    display: none;
    flex-direction: column;
    align-items: center;
    padding-top: 90px;
    padding-bottom: 60px;
  }
  #page3.active { display: flex; }

  .stats-title {
    font-family: 'Playfair Display', serif;
    font-size: 36px; color: var(--accent);
    margin-bottom: 8px; text-align: center;
  }
  .stats-sub { font-size: 11px; color: var(--text2); letter-spacing: 0.2em; margin-bottom: 40px; text-transform: uppercase; }

  .chart-wrapper {
    width: min(900px, 95vw);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px 24px 20px;
    margin-bottom: 28px;
    position: relative;
  }
  .chart-title { font-size: 11px; color: var(--text2); letter-spacing: 0.2em; margin-bottom: 20px; text-transform: uppercase; }

  canvas { width: 100% !important; }

  .stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 16px;
    width: min(900px, 95vw);
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
  }
  .stat-card .sc-val {
    font-family: 'Playfair Display', serif;
    font-size: 32px; color: var(--water);
    text-shadow: 0 0 15px rgba(56,189,248,0.3);
  }
  .stat-card .sc-label { font-size: 10px; color: var(--text2); letter-spacing: 0.15em; margin-top: 4px; text-transform: uppercase; }

  /* Floating bg */
  .bg-orb {
    position: fixed; border-radius: 50%;
    filter: blur(80px); pointer-events: none; z-index: -1;
    animation: drift 15s ease-in-out infinite;
  }
  @keyframes drift {
    0%,100%{transform:translate(0,0)}
    50%{transform:translate(30px,-30px)}
  }
  .orb1 { width:400px;height:400px;background:rgba(14,165,233,0.06);top:-100px;left:-100px; }
  .orb2 { width:300px;height:300px;background:rgba(56,189,248,0.05);bottom:-80px;right:-80px;animation-delay:-7s; }
</style>
</head>
<body>

<div class="bg-orb orb1"></div>
<div class="bg-orb orb2"></div>

<nav>
  <button onclick="showPage(1)" id="nav1" class="active">ðŸ’§ Bottle</button>
  <button onclick="showPage(2)" id="nav2">ðŸ“… Calendar</button>
  <button onclick="showPage(3)" id="nav3">ðŸ“ˆ Statistics</button>
</nav>

<!-- PAGE 1 -->
<div class="page active" id="page1">
  <h1 class="bottle-title">Daily Hydration</h1>
  <p class="bottle-subtitle">Click bottle or use slider to log water</p>

  <div class="bottle-wrapper">
    <div class="bottle-container">
      <svg class="bottle-svg" viewBox="0 0 160 500" onclick="handleBottleClick(event)" id="bottleSvg">
        <defs>
          <clipPath id="bottleClip">
            <path d="M55,40 L35,80 L20,100 L20,460 Q20,480 80,480 Q140,480 140,460 L140,100 L125,80 L105,40 Z"/>
          </clipPath>
          <linearGradient id="waterGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#7dd3fc" stop-opacity="0.9"/>
            <stop offset="100%" stop-color="#0369a1" stop-opacity="1"/>
          </linearGradient>
          <linearGradient id="bottleGrad" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%" stop-color="rgba(56,189,248,0.05)"/>
            <stop offset="40%" stop-color="rgba(56,189,248,0.12)"/>
            <stop offset="100%" stop-color="rgba(56,189,248,0.04)"/>
          </linearGradient>
        </defs>

        <!-- Bottle outline -->
        <path d="M55,40 L35,80 L20,100 L20,460 Q20,480 80,480 Q140,480 140,460 L140,100 L125,80 L105,40 Z"
              fill="url(#bottleGrad)" stroke="rgba(56,189,248,0.5)" stroke-width="1.5"/>

        <!-- Water fill -->
        <g clip-path="url(#bottleClip)">
          <rect id="waterRect" x="0" y="480" width="160" height="0" fill="url(#waterGrad)" rx="0">
            <animate attributeName="y" dur="0.5s" fill="freeze" id="waterAnim"/>
            <animate attributeName="height" dur="0.5s" fill="freeze" id="heightAnim"/>
          </rect>
          <!-- water wave -->
          <path id="wavePath" d="" fill="rgba(125,211,252,0.3)"/>
        </g>

        <!-- ML lines (100ml each = 30px spacing roughly) -->
        <g id="mlLines"></g>

        <!-- Bottle cap -->
        <rect x="62" y="10" width="36" height="32" rx="5" fill="rgba(56,189,248,0.2)" stroke="rgba(56,189,248,0.4)" stroke-width="1"/>
        <rect x="58" y="36" width="44" height="8" rx="2" fill="rgba(56,189,248,0.3)"/>

        <!-- Shine -->
        <path d="M35,100 Q38,120 35,200" stroke="rgba(255,255,255,0.12)" stroke-width="6" fill="none" stroke-linecap="round"/>
      </svg>

      <!-- Labels on right -->
      <div class="bottle-labels" id="bottleLabels"></div>
    </div>

    <div style="display:flex;flex-direction:column;align-items:center;gap:20px;">
      <div class="info-box">
        <div class="ml-display" id="mlDisplay">0</div>
        <div class="ml-label">ml consumed today</div>
      </div>

      <div class="goal-reached" id="goalReached">ðŸŽ‰ Goal Reached!</div>

      <div class="slider-row">
        <span style="font-size:10px;color:var(--text2)">0</span>
        <input type="range" id="mlSlider" min="0" max="3000" step="100" value="0" oninput="setFromSlider(this.value)">
        <span style="font-size:10px;color:var(--text2)">3L</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
        <button class="btn" onclick="addAmount(250)">+250ml</button>
        <button class="btn" onclick="addAmount(500)">+500ml</button>
        <button class="btn" onclick="addAmount(-250)">-250ml</button>
      </div>

      <button class="btn btn-primary" onclick="saveToday()">Save Today's Intake</button>
      <div id="saveMsg" style="font-size:11px;color:#4ade80;letter-spacing:0.1em;display:none;">Saved âœ“</div>
    </div>
  </div>
</div>

<!-- PAGE 2 -->
<div class="page" id="page2">
  <div class="cal-header">
    <button class="cal-nav" onclick="changeMonth(-1)">â€¹</button>
    <div class="cal-title" id="calTitle"></div>
    <button class="cal-nav" onclick="changeMonth(1)">â€º</button>
  </div>
  <div class="cal-grid" id="calGrid"></div>
</div>

<!-- PAGE 3 -->
<div class="page" id="page3">
  <h1 class="stats-title">Hydration Statistics</h1>
  <p class="stats-sub">Monthly overview</p>

  <div class="chart-wrapper">
    <div class="chart-title">Daily Average (ml) â€” Last 6 Months</div>
    <canvas id="lineChart" height="280"></canvas>
  </div>

  <div class="stats-cards" id="statsCards"></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalIfBg(event)">
  <div class="modal">
    <h3>Water Intake</h3>
    <div class="modal-date" id="modalDate"></div>
    <div class="modal-ml" id="modalMl">0</div>
    <div class="modal-ml-label">MILLILITERS</div>
    <input type="number" class="modal-input" id="modalInput" placeholder="Enter ml (e.g. 2000)" min="0" max="5000" oninput="updateModalPreview()">
    <div class="modal-btns">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveModal()">Save</button>
    </div>
  </div>
</div>

<script>
// ===== SUPABASE CONFIG =====
const SUPABASE_URL = 'https://rulczsxtozyhsdvnaija.supabase.co';
const SUPABASE_KEY = 'sb_publishable_hT5bkyLYHpx6E60zuj0sfQ_LYWrMq6K';

async function sbFetch(path, options = {}) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    ...options,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      ...(options.headers || {})
    }
  });
  if (!res.ok && res.status !== 204) {
    const err = await res.text();
    console.error('Supabase error:', err);
    return null;
  }
  if (res.status === 204) return null;
  return res.json();
}

async function loadAllData() {
  const rows = await sbFetch('water_intake?select=date,ml');
  if (rows) {
    rows.forEach(r => { data[r.date] = r.ml; });
  }
}

async function upsertEntry(date, ml) {
  await sbFetch('water_intake', {
    method: 'POST',
    headers: { 'Prefer': 'resolution=merge-duplicates' },
    body: JSON.stringify({ date, ml })
  });
}

// ===== DATA =====
let data = {};
try { data = JSON.parse(localStorage.getItem('aquaData') || '{}'); } catch(e){ data = {}; }

function saveData() { localStorage.setItem('aquaData', JSON.stringify(data)); }

function todayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ===== NAVIGATION =====
function showPage(n) {
  document.querySelectorAll('.page').forEach((p,i) => {
    p.classList.toggle('active', i+1 === n);
  });
  document.querySelectorAll('nav button').forEach((b,i) => {
    b.classList.toggle('active', i+1 === n);
  });
  if (n === 2) renderCalendar();
  if (n === 3) renderStats();
}

// ===== PAGE 1: BOTTLE =====
const TOTAL = 3000;
const STEPS = 30; // 30 lines = 100ml each
const BOTTLE_TOP = 80;   // y where bottle starts (after neck)
const BOTTLE_BOT = 465;  // y of bottle bottom
const BOTTLE_H = BOTTLE_BOT - BOTTLE_TOP;

let currentMl = data[todayKey()] || 0;

function initBottle() {
  // Draw ML lines
  const g = document.getElementById('mlLines');
  g.innerHTML = '';
  for (let i = 1; i <= STEPS; i++) {
    const frac = i / STEPS;
    const y = BOTTLE_BOT - frac * BOTTLE_H;
    // bottle width varies (tapered at top ~65px wide, bottom ~120px wide)
    const widthFrac = 1 - frac * 0.35;
    const halfW = 60 * widthFrac;
    const isMajor = i % 5 === 0;
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', 80 - halfW + 8);
    line.setAttribute('x2', 80 + halfW - 8);
    line.setAttribute('y1', y);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', isMajor ? 'rgba(56,189,248,0.35)' : 'rgba(56,189,248,0.15)');
    line.setAttribute('stroke-width', isMajor ? '1' : '0.5');
    g.appendChild(line);
  }

  // Labels
  const labels = document.getElementById('bottleLabels');
  labels.innerHTML = '';
  for (let i = 1; i <= STEPS; i++) {
    const div = document.createElement('div');
    div.className = 'bottle-label';
    div.id = `lbl-${i}`;
    if (i % 5 === 0) div.textContent = `${i*100} ml`;
    else div.textContent = '';
    labels.appendChild(div);
  }

  updateBottle(currentMl, false);
}

function updateBottle(ml, animate = true) {
  ml = Math.max(0, Math.min(TOTAL, ml));
  currentMl = ml;

  document.getElementById('mlDisplay').textContent = ml;
  const slider = document.getElementById('mlSlider');
  slider.value = ml;
  slider.style.setProperty('--pct', `${(ml/TOTAL)*100}%`);

  const goal = document.getElementById('goalReached');
  goal.style.display = ml >= 2000 ? 'block' : 'none';

  // Update water rect
  const frac = ml / TOTAL;
  const waterH = frac * BOTTLE_H;
  const waterY = BOTTLE_BOT - waterH;

  const rect = document.getElementById('waterRect');
  rect.setAttribute('y', waterY);
  rect.setAttribute('height', waterH + 15);

  // Wave
  if (ml > 0) {
    const wave = document.getElementById('wavePath');
    const waveY = waterY + 2;
    wave.setAttribute('d',
      `M20,${waveY} Q50,${waveY-6} 80,${waveY} Q110,${waveY+6} 140,${waveY} L140,${waterY-2} Q110,${waterY+4} 80,${waterY-2} Q50,${waterY-8} 20,${waterY-2} Z`
    );
  } else {
    document.getElementById('wavePath').setAttribute('d', '');
  }

  // Update labels highlight
  const filledSteps = Math.floor(ml / 100);
  for (let i = 1; i <= STEPS; i++) {
    const lbl = document.getElementById(`lbl-${i}`);
    if (lbl) lbl.classList.toggle('active-label', i <= filledSteps);
  }
}

function handleBottleClick(e) {
  const svg = document.getElementById('bottleSvg');
  const rect = svg.getBoundingClientRect();
  const clickY = e.clientY - rect.top;
  const svgH = rect.height;
  // Map clickY to 0..3000ml (inverted)
  const topFrac = (BOTTLE_TOP / 500);
  const botFrac = (BOTTLE_BOT / 500);
  const relY = (clickY / svgH - topFrac) / (botFrac - topFrac);
  const ml = Math.round((1 - Math.max(0, Math.min(1, relY))) * TOTAL / 100) * 100;
  updateBottle(ml);
}

function addAmount(amt) {
  updateBottle(currentMl + amt);
}

function setFromSlider(v) {
  updateBottle(parseInt(v));
}

async function saveToday() {
  data[todayKey()] = currentMl;
  saveData();
  await upsertEntry(todayKey(), currentMl);
  const msg = document.getElementById('saveMsg');
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', 2000);
}

// ===== PAGE 2: CALENDAR =====
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
let calYear = 2026, calMonth = 1; // Feb 2026 (0-indexed)

function changeMonth(dir) {
  calMonth += dir;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  if (calMonth < 0) { calMonth = 11; calYear--; }
  renderCalendar();
}

function renderCalendar() {
  document.getElementById('calTitle').textContent = `${MONTHS[calMonth]} ${calYear}`;
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';

  // Day names
  DAYS.forEach(d => {
    const el = document.createElement('div');
    el.className = 'cal-day-name';
    el.textContent = d;
    grid.appendChild(el);
  });

  const firstDay = new Date(calYear, calMonth, 1).getDay();
  const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
  const today = new Date();

  // Empty cells
  for (let i = 0; i < firstDay; i++) {
    const el = document.createElement('div');
    el.className = 'cal-day empty';
    grid.appendChild(el);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const key = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const ml = data[key] || 0;
    const isToday = (today.getFullYear()===calYear && today.getMonth()===calMonth && today.getDate()===d);

    const el = document.createElement('div');
    el.className = 'cal-day' + (isToday ? ' today' : '') + (ml > 0 ? ' has-data' : '');

    const fillPct = Math.min(100, (ml / 3000) * 100);
    el.innerHTML = `
      <div class="water-fill" style="height:${fillPct}%"></div>
      <div class="day-num">${d}</div>
      ${ml > 0 ? `<div class="day-ml">${ml}ml</div>` : ''}
    `;

    el.onclick = () => openModal(d, calYear, calMonth);
    grid.appendChild(el);
  }
}

// ===== MODAL =====
let modalDay, modalYear, modalMonth;

function openModal(day, year, month) {
  modalDay = day; modalYear = year; modalMonth = month;
  const key = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  const ml = data[key] || 0;
  document.getElementById('modalDate').textContent = `${day} ${MONTHS[month]} ${year}`;
  document.getElementById('modalMl').textContent = ml;
  document.getElementById('modalInput').value = ml || '';
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function closeModalIfBg(e) {
  if (e.target.id === 'modalOverlay') closeModal();
}

function updateModalPreview() {
  const v = parseInt(document.getElementById('modalInput').value) || 0;
  document.getElementById('modalMl').textContent = v;
}

async function saveModal() {
  const ml = parseInt(document.getElementById('modalInput').value) || 0;
  const key = `${modalYear}-${String(modalMonth+1).padStart(2,'0')}-${String(modalDay).padStart(2,'0')}`;
  data[key] = ml;
  saveData();
  await upsertEntry(key, ml);
  // If today, update bottle
  if (key === todayKey()) {
    currentMl = ml;
    updateBottle(ml);
  }
  closeModal();
  renderCalendar();
}

// ===== PAGE 3: STATS =====
function renderStats() {
  // Build monthly stats
  const today = new Date();
  const months = [];
  for (let i = 5; i >= 0; i--) {
    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
    months.push({ year: d.getFullYear(), month: d.getMonth(), label: MONTHS[d.getMonth()].slice(0,3) + ' ' + d.getFullYear() });
  }

  const monthlyAvgs = months.map(m => {
    const daysInMonth = new Date(m.year, m.month+1, 0).getDate();
    let total = 0, count = 0;
    for (let d = 1; d <= daysInMonth; d++) {
      const key = `${m.year}-${String(m.month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      if (data[key] !== undefined) {
        total += data[key];
        count++;
      }
    }
    return { ...m, avg: count > 0 ? Math.round(total/count) : 0, total, count };
  });

  // Draw chart
  const canvas = document.getElementById('lineChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.parentElement.offsetWidth - 48;
  const H = 280;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);

  const padL = 60, padR = 30, padT = 20, padB = 40;
  const chartW = W - padL - padR;
  const chartH = H - padT - padB;
  const maxVal = Math.max(...monthlyAvgs.map(m => m.avg), 2000);

  ctx.clearRect(0, 0, W, H);

  // Grid lines
  for (let i = 0; i <= 4; i++) {
    const y = padT + chartH * (1 - i/4);
    const v = Math.round((maxVal * i/4) / 100) * 100;
    ctx.strokeStyle = 'rgba(56,189,248,0.08)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL + chartW, y); ctx.stroke();
    ctx.fillStyle = 'rgba(148,163,184,0.7)';
    ctx.font = '9px DM Mono, monospace';
    ctx.textAlign = 'right';
    ctx.fillText(v, padL - 8, y + 3);
  }

  // Goal line at 2000
  const goalY = padT + chartH * (1 - 2000/maxVal);
  ctx.strokeStyle = 'rgba(74,222,128,0.25)';
  ctx.setLineDash([4, 4]);
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL, goalY); ctx.lineTo(padL + chartW, goalY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = 'rgba(74,222,128,0.5)';
  ctx.font = '9px DM Mono'; ctx.textAlign = 'left';
  ctx.fillText('goal 2000ml', padL + 4, goalY - 4);

  // X labels
  monthlyAvgs.forEach((m, i) => {
    const x = padL + (i / (monthlyAvgs.length-1)) * chartW;
    ctx.fillStyle = 'rgba(148,163,184,0.7)';
    ctx.font = '9px DM Mono'; ctx.textAlign = 'center';
    ctx.fillText(m.label, x, H - 8);
  });

  // Area fill
  const gradient = ctx.createLinearGradient(0, padT, 0, padT + chartH);
  gradient.addColorStop(0, 'rgba(56,189,248,0.3)');
  gradient.addColorStop(1, 'rgba(56,189,248,0.02)');

  ctx.beginPath();
  monthlyAvgs.forEach((m, i) => {
    const x = padL + (i / (monthlyAvgs.length-1)) * chartW;
    const y = padT + chartH * (1 - m.avg/maxVal);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.lineTo(padL + chartW, padT + chartH);
  ctx.lineTo(padL, padT + chartH);
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.strokeStyle = '#38bdf8';
  ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  monthlyAvgs.forEach((m, i) => {
    const x = padL + (i / (monthlyAvgs.length-1)) * chartW;
    const y = padT + chartH * (1 - m.avg/maxVal);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Dots
  monthlyAvgs.forEach((m, i) => {
    const x = padL + (i / (monthlyAvgs.length-1)) * chartW;
    const y = padT + chartH * (1 - m.avg/maxVal);
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI * 2);
    ctx.fillStyle = m.avg > 0 ? '#38bdf8' : '#1e3a5f';
    ctx.fill();
    ctx.strokeStyle = '#0a0f1e';
    ctx.lineWidth = 2;
    ctx.stroke();

    if (m.avg > 0) {
      ctx.fillStyle = '#f0f9ff';
      ctx.font = '10px DM Mono'; ctx.textAlign = 'center';
      ctx.fillText(m.avg, x, y - 12);
    }
  });

  // Stats cards
  const cards = document.getElementById('statsCards');
  cards.innerHTML = '';
  const thisMonth = monthlyAvgs[monthlyAvgs.length-1];
  const allAvg = monthlyAvgs.filter(m=>m.count>0);
  const overallAvg = allAvg.length ? Math.round(allAvg.reduce((s,m)=>s+m.avg,0)/allAvg.length) : 0;
  const totalDays = monthlyAvgs.reduce((s,m)=>s+m.count,0);
  const best = monthlyAvgs.reduce((a,m)=>m.avg>a.avg?m:a, {avg:0});

  [
    { val: thisMonth.avg || 0, label: "This Month Avg (ml)" },
    { val: overallAvg, label: "Overall Avg (ml)" },
    { val: totalDays, label: "Days Logged" },
    { val: best.avg || 0, label: `Best Month (${best.label||'â€”'})` },
  ].forEach(s => {
    cards.innerHTML += `
      <div class="stat-card">
        <div class="sc-val">${s.val.toLocaleString()}</div>
        <div class="sc-label">${s.label}</div>
      </div>`;
  });
}

// ===== INIT: Load from Supabase, then initialize =====
(async () => {
  await loadAllData();
  currentMl = data[todayKey()] || 0;
  initBottle();
  renderCalendar();
})();
</script>
</body>
</html>



